### [2023-12-02 15:30] Facebook Webhook 無法返回訊息問題排查
**提問者/發起者**：我  
**對話摘要**：
- 問題描述：Facebook Webhook 無法返回訊息，需檢查相關路由配置
- 解決方案建議：修改路由配置結構，解決路由混合導致的衝突問題
- 採納與否：採納
- 其他備註：主要問題在於所有路由共用同一個 Router 實例導致衝突

**完整對話內容**：
問題：現在 facebook.webhook 那邊不會返回訊息，幫我檢查一下相關檔案有沒有問題

解答：經過檢查發現主要問題在於路由配置混亂：
1. 在 routes/index.js 中，所有路由（apiRoutes、logRoutes、webhookRoutes）都被掛載到同一個 logRouter 實例上
2. 在 server.js 中，這個共用的 logRouter 被掛載到了三個不同的路徑上
3. 這導致 webhook 路由無法正確處理請求

解決方案：
1. 修改 routes/index.js，將每個路由模組分別導出
2. 修改 server.js 中的路由掛載路徑，使 webhook 路由掛載到正確的路徑上
3. 修正 aiResponseHandler.js 中的 useTestMode 參數使用問題

修改後，各路由將獨立運作，不再互相干擾。

### [2023-12-02 16:45] 修復 useTestMode 未定義錯誤
**提問者/發起者**：我  
**對話摘要**：
- 問題描述：Facebook webhook 處理時出現 "ReferenceError: useTestMode is not defined" 錯誤
- 解決方案建議：修正 conversationHandler.js 中的參數解構
- 採納與否：採納
- 其他備註：需要解構 options 參數以提取 useTestMode 值

**完整對話內容**：
問題：檢查 Facebook webhook 無法返回訊息的問題，發現錯誤：ReferenceError: useTestMode is not defined

解答：經分析錯誤堆疊，發現問題出在 utils/conversationHandler.js 的 processAndStoreConversation 函數中：

1. 問題原因：在 conversationHandler.js 中，用於從 options 參數中解構 useTestMode 的代碼被註釋掉了，導致在函數後續使用 useTestMode 變數時出現未定義錯誤

2. 錯誤堆疊：
   - 在 conversationHandler.js:395 的 processAndStoreConversation 函數中引用了未定義的 useTestMode
   - 這個函數被 aiResponseHandler.js:291 的 generateAIResponse 函數調用
   - 最終導致 facebook.webhook.controller.js 中的請求處理失敗

3. 解決方案：
   - 修改 processAndStoreConversation 函數，正確解構 options 參數
   - 取消註釋解構代碼，確保 useTestMode 變數在使用前已定義
   - 設置合適的默認值以提高穩健性

修改後，Facebook webhook 應能正確處理用戶訊息並存儲到相應資料庫中。

### [2023-12-03 14:00] Pinecone API 回應解析錯誤排查
**提問者/發起者**：我  
**對話摘要**：
- 問題描述：Pinecone 查詢時出現 "Unexpected end of JSON input" 錯誤
- 解決方案建議：增強錯誤處理和防呆機制，處理空響應或格式錯誤
- 採納與否：採納
- 其他備註：修改了兩個關鍵文件，添加了多層防呆處理

**完整對話內容**：
問題：遇到錯誤訊息「獲取現有 FAQ 失敗，詳細錯誤:錯誤名稱: SyntaxError，錯誤消息: Unexpected end of JSON input」，請幫忙檢查和修復。

解答：這個錯誤是 Pinecone 查詢時 API 回傳的內容不是合法 JSON，導致 JSON.parse 失敗。問題可能出現在以下幾種情況：

1. Pinecone 資料庫中沒有任何向量時，API 可能回傳空字串或不完整的 JSON
2. 網路連接不穩定導致回應被截斷
3. API 金鑰/索引名稱錯誤，導致回傳非預期內容

解決方案有兩部分：

1. 針對 `utils/vectorStoreHandler.js` 的 `fetchExistingFaqs` 函數：
   - 增加多層檢查和防呆處理，確保 pineconeIndex 有效
   - 對 fetch 請求使用 try-catch 包裝，避免異常中斷流程
   - 檢查回應內容是否有效，處理可能的空回應情況
   - 確保 vectors 屬性存在且格式正確
   - 添加更詳細的日誌記錄，便於調試

2. 針對 `utils/conversationHandler.js` 的 `storeConversationToVectorDB` 函數：
   - 增加對 conversation 對象的有效性檢查
   - 改進了錯誤處理邏輯，避免深層屬性引用導致的崩潰
   - 優化了回傳格式，提供更詳細的錯誤信息
   - 增強了對 MongoDB 更新失敗的處理

這些修改讓系統更加健壯，即使 Pinecone API 回傳異常，核心功能仍能繼續運行，避免因資料庫問題導致整個服務中斷。 