### [2023-12-02 15:30] 修復 Facebook Webhook 路由配置問題

**提交人**：我  
**更新摘要**：
- 修改檔案：`routes/index.js`, `server.js`, `utils/aiResponseHandler.js`
- 主要變更內容：
  - 修復路由器混合錯誤，將所有路由分別獨立導出
  - 修改 server.js 中的路由掛載路徑，確保 webhook 掛載到正確路徑
  - 修正 aiResponseHandler.js 中 useTestMode 參數設置問題
- 相關 Issue 或對話連結：對話關於「facebook.webhook 那邊不會返回訊息」問題
- 是否通過測試：初步測試通過
- 備註：Facebook Webhook 路由現在掛載在 /webhook 路徑下

**變更前後差異說明**：
- 前版本：所有路由共享同一個 Router 實例，導致路由混亂
- 後版本：各路由分開處理，apiRoutes、logRoutes 和 webhookRoutes 分別掛載到不同路徑

### [2023-12-02 16:45] 修復 useTestMode 未定義錯誤

**提交人**：我  
**更新摘要**：
- 修改檔案：`utils/conversationHandler.js`
- 主要變更內容：
  - 修正 processAndStoreConversation 函數中的選項參數解構
  - 取消註解從 options 中解構 useTestMode 和 syncProcess 參數的代碼
  - 確保在整個函數中能正確使用這些參數
- 相關 Issue 或對話連結：Facebook webhook 處理時出現 "ReferenceError: useTestMode is not defined" 錯誤
- 是否通過測試：待測試
- 備註：修復後應能正確處理 Facebook 發送的訊息並存儲到 MongoDB 和向量資料庫

**變更前後差異說明**：
- 前版本：未從 options 參數中解構 useTestMode，導致後續使用時出現未定義錯誤
- 後版本：正確解構 options 參數，確保 useTestMode 在需要時可用

### [2023-12-02 16:30] 修正 Facebook Webhook 路由路徑

**提交人**：我  
**更新摘要**：
- 修改檔案：`server.js`
- 主要變更內容：
  - 將 webhookRoutes 路由掛載從 `/api/facebook_bot` 改為根路徑 `/`
  - 確保 `/webhook` 端點能被正確處理
- 相關 Issue 或對話連結：Facebook webhook 無法返回訊息問題
- 是否通過測試：待測試
- 備註：Facebook 對 webhook 的路徑有嚴格要求，需確保路徑正確

**變更前後差異說明**：
- 前版本：webhook 路由掛載在 `/api/facebook_bot/webhook`
- 後版本：webhook 路由掛載在 `/webhook` 

### [2023-12-03 14:00] 增強向量資料庫處理的錯誤防呆機制

**提交人**：我  
**更新摘要**：
- 修改檔案：`utils/vectorStoreHandler.js`, `utils/conversationHandler.js`
- 主要變更內容：
  - 增強 `fetchExistingFaqs` 函數，添加多層防呆處理，避免 JSON 解析錯誤
  - 優化 `storeConversationToVectorDB` 函數，增加對象有效性檢查和更完善的錯誤處理
  - 改善日誌記錄，捕獲更多可能的錯誤情境
  - 解決 Pinecone API 回應為空或非預期格式時的處理
- 相關 Issue 或對話連結：討論關於 "Unexpected end of JSON input" 錯誤的解決方案
- 是否通過測試：初步測試通過
- 備註：重點是解決 Pinecone 互動時的穩定性問題，避免因資料庫回應異常導致整個程序崩潰

**變更前後差異說明**：
- 前版本：當 Pinecone 回應異常時，程式會直接拋出錯誤並中斷流程
- 後版本：程式能優雅處理各種異常情況，對空響應或格式錯誤有專門處理邏輯，確保核心功能不受影響

### [2023-08-14 12:15] 修復 Facebook Webhook 控制器的 logger 模組引用
**提交人**：我  
**更新摘要**：
- 修改檔案：`controllers/facebook.webhook.controller.js`
- 主要變更內容：
  - 修正 logger 模組的引用路徑，從 `'../utils/logger/logger'` 改為 `'../utils/logger'`
  - 確保系統能正確載入日誌功能
- 相關 Issue 或對話連結：見「對話紀錄.md」中 2023-08-14 12:10 條目
- 是否通過測試：已通過系統啟動測試
- 備註：合併代碼時需特別注意依賴模組路徑的正確性

**變更前後差異說明**：
- 前版本：
```javascript
// 錯誤的引用路徑
const logger = require('../utils/logger/logger');
```
- 後版本：
```javascript
// 正確的引用路徑
const logger = require('../utils/logger');
```

### [2023-08-15 10:30] 調整 AI 回應處理器為分類器功能
**提交人**：我  
**更新摘要**：
- 修改檔案：`utils/aiResponseHandler.js`
- 主要變更內容：
  - 修改 `getNewUserPromptTemplate` 函數中的系統提示模板
  - 將 AI 功能從回應生成改為訊息分類
  - 設置固定分類選項：["我是新朋友","出貨時間/出貨狀況","直播時間","付款方式/寄送方式","出貨時間","商品瑕疵/退貨","如何結單"]
  - 增強提示以確保 AI 只輸出指定分類選項中的一個
- 相關 Issue 或對話連結：關於訊息分類的需求討論
- 是否通過測試：初步測試通過
- 備註：此修改為前置處理流程的一部分，後續將根據分類結果調用對應的回應模板

**變更前後差異說明**：
- 前版本：AI 根據用戶輸入直接生成完整客服回應
- 後版本：AI 將用戶輸入分類到預定義的類別中，僅輸出類別名稱，為後續精確回應做準備 

### [2023-08-15 14:45] 優化 AI 分類功能: 從 MongoDB 動態獲取分類選項
**提交人**：我  
**更新摘要**：
- 修改檔案：`utils/aiResponseHandler.js`
- 主要變更內容：
  - 新增 `getClassificationOptionsFromDB` 函數，從 MongoDB 的 LevelOneQuestion 集合獲取分類選項和指南
  - 修改 `getNewUserPromptTemplate` 和 `getExistingUserPromptTemplate` 函數為非同步 (async)，使用數據庫中的分類選項
  - 實現緩存機制，設置緩存有效期為 30 分鐘，避免頻繁查詢數據庫
  - 加入錯誤處理和默認值機制，確保數據庫連接問題不影響系統運行
- 相關 Issue 或對話連結：見「對話紀錄.md」中 2023-08-15 "優化分類選項管理：從數據庫動態獲取" 條目
- 是否通過測試：已通過本地測試
- 備註：需在生產環境部署前測試與數據庫的連接穩定性

**變更前後差異說明**：
- 前版本：分類選項和指南硬編碼在 JS 文件中，修改需調整代碼並重新部署
- 後版本：分類選項和指南從數據庫動態獲取，可通過管理界面調整而無需修改代碼
- 改進的關鍵點：
  1. 增加了系統的可維護性和擴展性
  2. 引入緩存機制降低數據庫負載
  3. 使用默認值保證系統穩定性 

### [2023-08-16 09:30] 在 AI 回應處理器中添加 JSON 格式驗證和重試機制
**提交人**：我  
**更新摘要**：
- 修改檔案：`utils/aiResponseHandler.js`
- 主要變更內容：
  - 新增 `validateAndParseJsonResponse` 函數用於驗證 AI 回應是否為有效的 JSON 格式
  - 在 `generateAIResponse` 函數中添加重試機制，最多嘗試 3 次獲取有效的 JSON 格式回應
  - 改進錯誤處理流程，當所有重試都失敗時返回預設的 JSON 格式回應
  - 優化清理過程，處理可能的代碼塊標記等非 JSON 內容
- 相關 Issue 或對話連結：關於 AI 回應格式驗證的需求討論
- 是否通過測試：已通過本地測試
- 備註：此更新提高了系統的穩定性，確保即使 AI 模型回應格式不正確，系統仍能返回有效的 JSON 數據

**變更前後差異說明**：
- 前版本：直接使用 AI 回應，若格式不正確可能導致下游處理錯誤
- 後版本：添加多層驗證和重試機制，確保返回結果總是有效的 JSON 格式
- 改進的關鍵點：
  1. 使用正則表達式進行初步格式檢查
  2. 完整的 JSON 解析和屬性驗證
  3. 智能重試機制減少錯誤率
  4. 預設回應確保系統穩定性 

### [2023-08-16 15:45] 重構 AI 回應處理器：提取重試邏輯至獨立函數
**提交人**：我  
**更新摘要**：
- 修改檔案：`utils/aiResponseHandler.js`
- 主要變更內容：
  - 創建新的 `processAIResponseWithRetry` 函數，將重試邏輯提取為獨立模塊
  - 改進日誌記錄，增加 `ai_raw_response` 類型標識原始 AI 回應
  - 優化錯誤處理，使用可選鏈操作符 (`?.`) 避免可能的空值引用
  - 重構後的代碼更具可讀性和可維護性
- 相關 Issue 或對話連結：關於 AI 回應中出現的 "Missing value for input variable" 錯誤討論
- 是否通過測試：已通過本地測試
- 備註：重構後的代碼結構更清晰，便於未來擴展和維護

**變更前後差異說明**：
- 前版本：重試邏輯直接嵌入在 `generateAIResponse` 函數中，增加了函數的複雜度
- 後版本：將重試邏輯提取到獨立函數中，提高代碼可讀性，降低主函數複雜度
- 改進的關鍵點：
  1. 更好的關注點分離，每個函數職責更明確
  2. 改進的錯誤處理，使用可選鏈避免空值引用問題
  3. 更詳細的日誌記錄，便於問題診斷
  4. 更好的代碼組織，提高可維護性 

### [2023-08-16 17:30] 增強 AI 回應處理器：添加從 MongoDB 獲取答案的功能
**提交人**：我  
**更新摘要**：
- 修改檔案：`utils/aiResponseHandler.js`
- 主要變更內容：
  - 添加新的 `findAnswerByCategory` 函數，用於根據分類結果查詢 MongoDB 中對應的答案
  - 在 `generateAIResponse` 函數中解析 AI 回應 JSON，獲取分類結果
  - 使用分類結果查詢 MongoDB 的 LevelOneQuestion 集合，獲取預設答案
  - 優先返回數據庫中的預設答案，如找不到則返回原始 AI 回應
  - 增強日誌記錄，詳細跟踪查詢過程和結果
- 相關 Issue 或對話連結：關於優化客服回應生成流程的討論
- 是否通過測試：已通過初步測試
- 備註：此更新完成了 AI 分類器與預設答案庫的整合，使系統能返回更一致的回應

**變更前後差異說明**：
- 前版本：AI 回應僅返回分類結果的 JSON 格式數據，需要另外處理才能生成實際回應
- 後版本：系統直接根據 AI 返回的分類結果查詢數據庫，返回對應的預設答案
- 改進的關鍵點：
  1. 完成「分類-回應」二階段流程，確保回應的一致性
  2. 簡化後續處理流程，客戶端可直接使用返回的答案而無需額外處理
  3. 提供完整的錯誤處理，確保系統穩定性
  4. 詳細的日誌記錄，便於監控和分析系統運行情況 

### [2023-08-17 09:30] 在 Facebook Webhook 控制器中實現對話狀態機
**提交人**：我  
**更新摘要**：
- 修改檔案：`controller/facebook.webhook.controller.js`
- 主要變更內容：
  - 添加 `DialogueFSM` 類，實現對話狀態機，處理用戶消息的完整性判斷
  - 創建 `userFsmMap` 用於存儲每個用戶的狀態機實例
  - 修改 `handleIncomingMessage` 函數，使用狀態機處理用戶消息
  - 只有當消息語意完整或完成對話片段時才調用 AI 生成回應
  - 對不完整語意提供簡單提示，引導用戶繼續完成消息
- 相關 Issue 或對話連結：關於改進用戶訊息處理流程的討論
- 是否通過測試：已通過初步測試
- 備註：此更新提高了系統對用戶多輪對話的處理能力，避免對不完整消息生成不必要的 AI 回應

**變更前後差異說明**：
- 前版本：系統對每條用戶消息都立即生成 AI 回應，無論消息是否完整
- 後版本：使用狀態機判斷消息完整性，只對完整消息生成 AI 回應，提升交互體驗
- 改進的關鍵點：
  1. 實現對話狀態追踪，避免對不完整消息重複生成AI回應
  2. 優化用戶交互體驗，通過提示引導用戶完成消息
  3. 減少不必要的 AI 調用，降低資源消耗
  4. 支持多輪消息合併處理，提高系統理解長句複雜需求的能力 